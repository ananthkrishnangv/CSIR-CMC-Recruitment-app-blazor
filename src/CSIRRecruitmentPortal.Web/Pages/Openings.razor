@page "/openings"
@using CSIRRecruitmentPortal.Shared.DTOs
@using CSIRRecruitmentPortal.Shared.Enums
@using CSIRRecruitmentPortal.Web.Services
@inject IPostService PostService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Job Openings - CSIR Madras Complex</PageTitle>

<div class="container mx-auto px-4 py-8">
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">Current Job Openings</h1>
        <p class="text-slate-600">Explore career opportunities at CSIR Madras Complex.</p>
    </div>
    
    <div class="max-w-4xl mx-auto mb-8 bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex flex-col md:flex-row gap-4">
        <MudTextField @bind-Value="searchQuery" Placeholder="Search by title or code..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Class="flex-grow" Immediate="true" />
        <MudSelect T="string" @bind-Value="selectedDepartment" Label="Department" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem Value="@("")">All Departments</MudSelectItem>
             @foreach (var dept in departments)
            {
                <MudSelectItem Value="@dept">@dept</MudSelectItem>
            }
        </MudSelect>
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center p-12">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        </div>
    }
    else if (!FilteredPosts.Any())
    {
        <div class="text-center py-16 bg-slate-50 rounded-lg border border-dashed border-slate-300">
            <MudIcon Icon="@Icons.Material.Filled.WorkOff" Size="Size.Large" Class="text-slate-400 mb-4" />
            <h3 class="text-xl font-bold text-slate-600">No Openings Found</h3>
             <p class="text-slate-500">There are no active job posts matching your criteria at this time.</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 gap-6 max-w-4xl mx-auto">
            @foreach (var post in FilteredPosts)
            {
                <MudCard Class="hover:shadow-md transition-shadow">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">@post.Code</MudChip>
                                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wide">@post.Department</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-800">@post.Title</h3>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-slate-700">Deadline</div>
                                    <div class="@(GetDateColor(post.LastDate)) text-sm">@post.LastDate.ToString("dd MMM yyyy")</div>
                                </div>
                            </div>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <p class="text-slate-600 text-sm line-clamp-2">@post.Description</p>
                        
                        <div class="mt-4 flex flex-wrap gap-4 text-xs text-slate-500">
                             <div class="flex items-center">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" /> 
                                @post.Vacancies Vacancies
                            </div>
                            <div class="flex items-center">
                                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Class="mr-1" /> 
                                @post.Type
                            </div>
                        </div>
                    </MudCardContent>
                    <MudCardActions Class="border-t border-slate-100 bg-slate-50 px-4 py-3">
                        <MudSpacer />
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/details/{post.Id}")">View Details</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => ApplyNow(post.Id))">Apply Now</MudButton>
                    </MudCardActions>
                </MudCard>
            }
        </div>
    }
</div>

@code {
    private List<JobPostDto> posts = new();
    private bool isLoading = true;
    private string searchQuery = "";
    private string selectedDepartment = "";
    private List<string> departments = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            posts = await PostService.GetAllPostsAsync();
            departments = posts.Select(p => p.Department).Distinct().OrderBy(d => d).ToList();
        }
        catch (Exception ex)
        {
            // Log error
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<JobPostDto> FilteredPosts => posts
        .Where(p => string.IsNullOrWhiteSpace(searchQuery) || 
                    p.Title.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) || 
                    p.Code.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
        .Where(p => string.IsNullOrWhiteSpace(selectedDepartment) || p.Department == selectedDepartment);

    private string GetDateColor(DateTime date)
    {
        var daysLeft = (date - DateTime.UtcNow).TotalDays;
        if (daysLeft < 3) return "text-red-600 font-bold";
        if (daysLeft < 7) return "text-orange-600 font-bold";
        return "text-slate-600";
    }

    private async Task ApplyNow(Guid postId)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated ?? false)
        {
            Navigation.NavigateTo($"/apply/{postId}");
        }
        else
        {
            Navigation.NavigateTo($"/login?returnUrl=/apply/{postId}");
        }
    }
}
